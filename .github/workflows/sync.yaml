name: Sync Upstream Repository

on:
  schedule:
    - cron: '0 9 * * *' # PDT å‡Œæ™¨ 2 ç‚¹ (UTC ä¸Šåˆ 9 ç‚¹)
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync even if no changes detected'
        required: false
        default: 'false'
        type: boolean
  push:
    branches: [ main ]

jobs:
  sync-upstream:
    name: Sync with Upstream
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # èŽ·å–å®Œæ•´åŽ†å²
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add Upstream Remote
        run: |
          git remote add upstream https://github.com/LibreSpark/LibreTV || true
          git remote set-url upstream https://github.com/LibreSpark/LibreTV

      - name: Fetch Upstream Changes
        run: |
          echo "ðŸ“¡ Fetching changes from upstream repository..."
          git fetch upstream
          git fetch origin

      - name: Check for Updates
        id: check_updates
        run: |
          UPSTREAM_COMMIT=$(git rev-parse upstream/main)
          CURRENT_COMMIT=$(git rev-parse HEAD)
          echo "ðŸ” Current commit: $CURRENT_COMMIT"
          echo "ðŸ” Upstream commit: $UPSTREAM_COMMIT"
          if [ "$UPSTREAM_COMMIT" != "$CURRENT_COMMIT" ]; then
            echo "âœ… New changes detected in upstream repository"
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "upstream_commit=$UPSTREAM_COMMIT" >> $GITHUB_OUTPUT
            git log --oneline $CURRENT_COMMIT..$UPSTREAM_COMMIT || true
          else
            echo "â„¹ï¸ No new changes in upstream repository"
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Reset to Upstream
        if: steps.check_updates.outputs.has_updates == 'true' || github.event.inputs.force_sync == 'true'
        run: |
          echo "ðŸ”„ Syncing changes from upstream..."
          # é‡ç½®åˆ°ä¸Šæ¸¸ main åˆ†æ”¯ï¼Œè¦†ç›–æœ¬åœ°åŽ†å²
          git reset --hard upstream/main
          echo "âœ… Repository reset to upstream/main"

      - name: Remove Unnecessary Workflow Files (Exclude sync.yml)
        if: steps.check_updates.outputs.has_updates == 'true' || github.event.inputs.force_sync == 'true'
        run: |
          echo "ðŸ—‘ï¸ Removing unnecessary workflow files (excluding sync.yml)..."
          git rm -r .github/workflows/* --exclude=.github/workflows/sync.yml || true
          echo "âœ… Unnecessary files removed"

      - name: Commit Changes
        if: steps.check_updates.outputs.has_updates == 'true' || github.event.inputs.force_sync == 'true'
        run: |
          git add .
          git commit -m "Remove unnecessary workflow files (excluding sync.yml) and sync with upstream" || echo "No changes to commit"
          echo "âœ… Changes committed"

      - name: Push Changes
        if: steps.check_updates.outputs.has_updates == 'true' || github.event.inputs.force_sync == 'true'
        run: |
          echo "ðŸ“¤ Pushing synced changes..."
          git push origin main --force
          echo "âœ… Successfully synced with upstream repository"

      - name: Create Summary
        if: always()
        run: |
          echo "## ðŸ”„ Upstream Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_updates.outputs.has_updates }}" == "true" ]; then
            echo "âœ… **Status**: Repository successfully synced with upstream" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“Š **Upstream Commit**: \`${{ steps.check_updates.outputs.upstream_commit }}\`" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event.inputs.force_sync }}" == "true" ]; then
            echo "ðŸ”„ **Status**: Force sync completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **Status**: No updates available from upstream" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â° **Last Check**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Upstream**: https://github.com/LibreSpark/LibreTV" >> $GITHUB_STEP_SUMMARY

      - name: Notify on Failure
        if: failure()
        run: |
          echo "## âŒ Sync Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The upstream sync process encountered an error. Please check the logs above for more details." >> $GITHUB_STEP_SUMMARY
          echo "You may need to manually resolve conflicts or check the upstream repository status." >> $GITHUB_STEP_SUMMARY
